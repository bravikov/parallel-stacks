<!DOCTYPE html>
<html lang="ru" style="height: 100%; margin: 0; padding: 0;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: var(--vscode-font-family, -apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif);
            background-color: var(--vscode-editor-background, #1e1e1e);
            color: var(--vscode-editor-foreground, #d4d4d4);
            position: relative;
        }
        #svg-container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            background: var(--vscode-editor-background, #1e1e1e);
        }

        #controls {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 2;
        }

        #save-svg {
            background: var(--vscode-button-background, #0e639c);
            color: var(--vscode-button-foreground, #ffffff);
            border: 1px solid var(--vscode-button-border, transparent);
            border-radius: 4px;
            padding: 6px 10px;
            font: inherit;
            cursor: pointer;
        }

        #save-svg:hover {
            filter: brightness(1.05);
        }

        #save-svg:active {
            filter: brightness(0.95);
        }

        #svg-container svg {
            flex: 1;
            width: 100%;
            height: 100%;
            background: var(--vscode-editor-background, #1e1e1e);
        }

        #svg-container svg .graph polygon {
            fill: var(--vscode-editor-background, #1e1e1e) !important;
            stroke: none !important;
        }

        #svg-container svg .node polygon,
        #svg-container svg .node path,
        #svg-container svg .node polyline,
        #svg-container svg .node rect,
        #svg-container svg .node ellipse,
        #svg-container svg .node line {
            stroke: var(--vscode-editor-foreground, #d4d4d4) !important;
            fill: none !important;
        }

        #svg-container svg .node text {
            stroke: none !important;
            fill: var(--vscode-editor-foreground, #d4d4d4) !important;
        }

        #svg-container svg .edge path {
            stroke: var(--vscode-editor-foreground, #d4d4d4) !important;
            fill: none !important;
        }

        #svg-container svg .edge polygon {
            stroke: var(--vscode-editor-foreground, #d4d4d4) !important;
            fill: var(--vscode-editor-foreground, #d4d4d4) !important;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button id="save-svg" type="button" title="Save SVG">Save SVG</button>
    </div>
    <div id="svg-container">{{SVG_CONTENT}}</div>

    <!-- подключение библиотеки -->
    <script src="{{SVG_PAN_ZOOM_URI}}"></script>
    <script>
        const vscodeApi = acquireVsCodeApi();
        const svgElement = document.querySelector('svg');
        if (!svgElement) {
            console.error('Parallel Stacks: SVG root not found');
        } else {
            const selectableTags = new Set(['text', 'tspan', 'textpath']);
            const shouldBypassPan = (target) => {
                if (!(target instanceof Element)) {
                    return false;
                }
                let current = target;
                while (current && current !== svgElement) {
                    if (selectableTags.has(current.tagName.toLowerCase())) {
                        return true;
                    }
                    current = current.parentElement;
                }
                return false;
            };

            const panZoom = svgPanZoom(svgElement, {
                zoomEnabled: true,
                controlIconsEnabled: true,
                fit: true,
                center: true,
                minZoom: 0.1,
                maxZoom: 10
            });

            ['mousedown', 'touchstart', 'dblclick'].forEach((eventName) => {
                svgElement.addEventListener(eventName, (event) => {
                    if (shouldBypassPan(event.target)) {
                        event.stopImmediatePropagation();
                    }
                }, true);
            });
        }

        const resolveThemeCss = () => {
            const styles = getComputedStyle(document.documentElement);
            const bg = styles.getPropertyValue('--vscode-editor-background').trim() || '#1e1e1e';
            const fg = styles.getPropertyValue('--vscode-editor-foreground').trim() || '#d4d4d4';

            return `
            .graph polygon {
                fill: ${bg} !important;
                stroke: none !important;
            }

            .node polygon,
            .node path,
            .node polyline,
            .node rect,
            .node ellipse,
            .node line {
                stroke: ${fg} !important;
                fill: none !important;
            }

            .node text {
                stroke: none !important;
                fill: ${fg} !important;
            }

            .edge path {
                stroke: ${fg} !important;
                fill: none !important;
            }

            .edge polygon {
                stroke: ${fg} !important;
                fill: ${fg} !important;
            }
            `;
        };

        const saveButton = document.getElementById('save-svg');
        if (saveButton && svgElement) {
            saveButton.addEventListener('click', () => {
                const clone = svgElement.cloneNode(true);
                const styleNode = document.createElementNS('http://www.w3.org/2000/svg', 'style');
                styleNode.setAttribute('type', 'text/css');
                styleNode.textContent = resolveThemeCss();
                clone.insertBefore(styleNode, clone.firstChild);

                const removePanZoomControls = () => {
                    const controlClasses = [
                        'svg-pan-zoom-control',
                        'svg-pan-zoom-control-background',
                        'svg-pan-zoom-zoom-in',
                        'svg-pan-zoom-zoom-out',
                        'svg-pan-zoom-reset'
                    ];
                    controlClasses.forEach((cls) => {
                        clone.querySelectorAll(`.${cls}`).forEach((node) => node.remove());
                    });
                };
                removePanZoomControls();

                const serializedSvg = new XMLSerializer().serializeToString(clone);
                vscodeApi.postMessage({ type: 'saveSvg', content: serializedSvg });
            });
        }
    </script>
</body>
</html>
